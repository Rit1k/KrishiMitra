<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Information</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="./assets/mainlogo.svg" type="image/svg+xml" style="filter: invert(32%) sepia(29%) saturate(1096%) hue-rotate(89deg) brightness(92%) contrast(86%);">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .weather-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .location-header {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-info h2 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .location-info p {
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            border: 1px solid #eee;
            border-bottom: none;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            background: #f8f8f8;
            flex-grow: 1;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #2c5f2d;
            color: #2c5f2d;
        }

        .tab:hover:not(.active) {
            background: #f0f0f0;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 2rem;
            min-height: 400px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #eee;
            margin-bottom: 2rem;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Current Weather Styles */
        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .weather-item {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .weather-item i {
            font-size: 2rem;
            color: #2c5f2d;
            margin-bottom: 1rem;
        }

        .weather-item h3 {
            font-size: 1rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .weather-item p {
            font-size: 1.5rem;
            color: #333;
            font-weight: 500;
        }

        /* Forecast Styles */
        .forecast {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .forecast-item {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .forecast-item h4 {
            color: #666;
            margin-bottom: 1rem;
        }

        .forecast-item i {
            font-size: 2rem;
            color: #2c5f2d;
            margin: 1rem 0;
        }

        .forecast-item .temp {
            font-size: 1.25rem;
            font-weight: 500;
            color: #333;
        }

        /* Soil Data Styles */
        .soil-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .soil-item {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .soil-item i {
            font-size: 2rem;
            color: #2c5f2d;
            margin-bottom: 1rem;
        }

        .soil-item h3 {
            font-size: 1rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .soil-item p {
            font-size: 1.5rem;
            color: #333;
            font-weight: 500;
        }

        /* Map Styles */
        #weatherMap {
            height: 500px;
            width: 100%;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .loading i {
            font-size: 2rem;
            color: #2c5f2d;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex-basis: 50%;
            }
            
            .weather-details, .soil-data {
                grid-template-columns: 1fr 1fr;
            }
            
            .forecast {
                grid-template-columns: 1fr 1fr;
            }

            #weatherMap {
                height: 400px;
            }
        }

        @media (max-width: 480px) {
            .location-header {
                flex-direction: column;
                text-align: center;
            }
            
            .tab {
                flex-basis: 100%;
            }
            
            .weather-details, .soil-data {
                grid-template-columns: 1fr;
            }
            
            .forecast {
                grid-template-columns: 1fr;
            }

            #weatherMap {
                height: 300px;
            }
        }

        /* Debug panel styles */
        .debug-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 350px;
            height: 300px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            border-radius: 10px 0 0 0;
            z-index: 9999;
            overflow: auto;
            font-size: 12px;
            display: none;
            border: 1px solid #0f0;
        }
        
        .debug-panel.active {
            display: block;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0,255,0,0.3);
        }
        
        .debug-controls {
            display: flex;
            margin-bottom: 10px;
            gap: 5px;
        }
        
        .debug-controls button {
            background: #333;
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .debug-log {
            margin: 0;
            padding: 0;
            list-style-type: none;
        }
        
        .debug-log li {
            border-bottom: 1px dashed rgba(0,255,0,0.3);
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
        
        .debug-log li.error {
            color: #ff4444;
        }
        
        .debug-log li.warn {
            color: #ffbb33;
        }
        
        .debug-log li.info {
            color: #33b5e5;
        }
        
        .debug-timestamp {
            color: #999;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <img src="logo.svg" alt="Krishimitra Logo" class="logo-img">
                <h1>KrishiMitra</h1>
            </div>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="disease-detection.html">Disease Detection</a></li>
                <li><a href="weather.html">Weather</a></li>
                <li><a href="transport.html">Transport</a></li>
                <li><a href="chatbot.html">AI Chat</a></li>
                <li><a href="sms-admin.html">SMS Admin</a></li>
                <li><a href="email-admin.html">Email Admin</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="weather-container">
            <div class="location-header">
                <div class="location-info">
                    <h2>Weather Information</h2>
                    <p id="currentLocation"><i class="fas fa-map-marker-alt"></i> Loading location...</p>
                </div>
                <div class="last-updated">
                    <p id="lastUpdated">Last updated: --</p>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="current">Current Weather</div>
                <div class="tab" data-tab="forecast">5-Day Forecast</div>
                <div class="tab" data-tab="soil">Soil Data</div>
                <div class="tab" data-tab="map">Weather Map</div>
            </div>

            <div class="tab-content">
                <!-- Current Weather Tab -->
                <div class="tab-pane active" id="currentTab">
                    <div id="currentWeatherLoading" class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading current weather...</p>
                    </div>
                    <div id="currentWeatherContent" style="display: none;">
                        <div class="weather-overview">
                            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 2rem;">
                                <div style="text-align: center; margin-right: 2rem;">
                                    <i id="weatherIcon" class="fas fa-cloud-sun" style="font-size: 4rem; color: #2c5f2d;"></i>
                                    <h3 id="weatherDescription">--</h3>
                                </div>
                                <div style="text-align: center;">
                                    <div id="temperature" style="font-size: 3rem; font-weight: bold;">--°C</div>
                                    <div style="display: flex; gap: 1rem;">
                                        <div>H: <span id="maxTemp">--°C</span></div>
                                        <div>L: <span id="minTemp">--°C</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="weather-details">
                            <div class="weather-item">
                                <i class="fas fa-tint"></i>
                                <h3>Humidity</h3>
                                <p id="humidity">--%</p>
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-wind"></i>
                                <h3>Wind Speed</h3>
                                <p id="windSpeed">-- km/h</p>
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-cloud-rain"></i>
                                <h3>Rainfall Chance</h3>
                                <p id="rainChance">--%</p>
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-eye"></i>
                                <h3>Visibility</h3>
                                <p id="visibility">-- km</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Forecast Tab -->
                <div class="tab-pane" id="forecastTab">
                    <div id="forecastLoading" class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading forecast data...</p>
                    </div>
                    <div id="forecastContent" style="display: none;">
                        <div class="forecast" id="forecastContainer">
                            <!-- Forecast items will be added dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Soil Data Tab -->
                <div class="tab-pane" id="soilTab">
                    <div id="soilLoading" class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading soil data...</p>
                    </div>
                    <div id="soilContent" style="display: none;">
                        <div class="soil-data">
                            <div class="soil-item">
                                <i class="fas fa-water"></i>
                                <h3>Soil Moisture</h3>
                                <p id="soilMoisture">--%</p>
                            </div>
                            <div class="soil-item">
                                <i class="fas fa-thermometer-half"></i>
                                <h3>Soil Temperature</h3>
                                <p id="soilTemperature">--°C</p>
                            </div>
                            <div class="soil-item">
                                <i class="fas fa-flask"></i>
                                <h3>Soil pH</h3>
                                <p id="soilPH">--</p>
                            </div>
                            <div class="soil-item">
                                <i class="fas fa-leaf"></i>
                                <h3>Fertility Index</h3>
                                <p id="fertilityIndex">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map Tab -->
                <div class="tab-pane" id="mapTab">
                    <p>Click on any location on the map to view its weather information.</p>
                    <div id="weatherMap"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Debug toggle button -->
    <button class="debug-toggle" id="debugToggle"><i class="fas fa-bug"></i></button>
    
    <!-- Debug panel -->
    <div class="debug-panel" id="debugPanel">
        <h3 style="margin-top: 0">Debug Console</h3>
        <div class="debug-controls">
            <button id="debugClear">Clear</button>
            <button id="debugTest">Test API</button>
            <button id="debugLocation">Test Location</button>
            <button id="debugNetworkInfo">Network Info</button>
        </div>
        <ul class="debug-log" id="debugLog"></ul>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDL5-NPEXTiywSZAtjj9-oOvF3T-tLuj7w&callback=initMap" async defer></script>
    <script>
        // Debug functionality
        const DEBUG = {
            logs: [],
            maxLogs: 100,
            active: false,
            
            init() {
                this.debugPanel = document.getElementById('debugPanel');
                this.debugLog = document.getElementById('debugLog');
                this.debugToggle = document.getElementById('debugToggle');
                
                // Toggle debug panel
                this.debugToggle.addEventListener('click', () => {
                    this.active = !this.active;
                    this.debugPanel.classList.toggle('active', this.active);
                });
                
                // Clear logs
                document.getElementById('debugClear').addEventListener('click', () => {
                    this.clear();
                });
                
                // Test API
                document.getElementById('debugTest').addEventListener('click', () => {
                    this.testAPIs();
                });
                
                // Test location
                document.getElementById('debugLocation').addEventListener('click', () => {
                    this.testLocation();
                });
                
                // Network info
                document.getElementById('debugNetworkInfo').addEventListener('click', () => {
                    this.getNetworkInfo();
                });
                
                // Override console methods
                const originalConsole = {
                    log: console.log,
                    error: console.error,
                    warn: console.warn,
                    info: console.info
                };
                
                console.log = (...args) => {
                    originalConsole.log(...args);
                    this.log('log', ...args);
                };
                
                console.error = (...args) => {
                    originalConsole.error(...args);
                    this.log('error', ...args);
                };
                
                console.warn = (...args) => {
                    originalConsole.warn(...args);
                    this.log('warn', ...args);
                };
                
                console.info = (...args) => {
                    originalConsole.info(...args);
                    this.log('info', ...args);
                };
                
                // Setup error catching
                window.addEventListener('error', (e) => {
                    this.log('error', `Uncaught error: ${e.message} at ${e.filename}:${e.lineno}`);
                });
                
                window.addEventListener('unhandledrejection', (e) => {
                    this.log('error', `Unhandled promise rejection: ${e.reason}`);
                });
                
                // Initial log
                this.log('info', 'Debug console initialized');
            },
            
            log(type, ...messages) {
                const now = new Date();
                const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                
                let message;
                try {
                    message = messages.map(m => {
                        if (typeof m === 'object') {
                            return JSON.stringify(m);
                        }
                        return String(m);
                    }).join(' ');
                } catch (e) {
                    message = 'Error stringifying log message';
                }
                
                this.logs.push({ type, timestamp, message });
                
                // Trim logs if needed
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(-this.maxLogs);
                }
                
                this.updateDisplay();
            },
            
            updateDisplay() {
                if (!this.debugLog) return;
                
                this.debugLog.innerHTML = '';
                
                this.logs.forEach(log => {
                    const li = document.createElement('li');
                    li.className = log.type;
                    
                    const span = document.createElement('span');
                    span.className = 'debug-timestamp';
                    span.textContent = log.timestamp;
                    
                    li.appendChild(span);
                    li.appendChild(document.createTextNode(log.message));
                    
                    this.debugLog.appendChild(li);
                });
                
                // Auto-scroll to bottom
                this.debugLog.scrollTop = this.debugLog.scrollHeight;
            },
            
            clear() {
                this.logs = [];
                this.updateDisplay();
                this.log('info', 'Logs cleared');
            },
            
            testAPIs() {
                this.log('info', 'Testing APIs...');
                
                if (!isApiKeyConfigured()) {
                    this.log('error', 'OpenWeather API key is not configured. Please add a valid API key.');
                    return;
                }
                
                // Test OpenWeather API
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=20.5937&lon=78.9629&units=metric&appid=${apiKey}`)
                    .then(response => response.json())
                    .then(data => {
                        this.log('info', 'OpenWeather API test successful', data);
                    })
                    .catch(error => {
                        this.log('error', 'OpenWeather API test failed:', error);
                    });
                
                // Test OpenWeather One Call API
                fetch(`https://api.openweathermap.org/data/2.5/onecall?lat=20.5937&lon=78.9629&exclude=minutely,hourly,alerts&units=metric&appid=${apiKey}`)
                    .then(response => response.json())
                    .then(data => {
                        this.log('info', 'OpenWeather OneCall API test successful', data);
                    })
                    .catch(error => {
                        this.log('error', 'OpenWeather OneCall API test failed:', error);
                    });
                
                // Test Geocoding API
                fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=20.5937&lon=78.9629&limit=1&appid=${apiKey}`)
                    .then(response => response.json())
                    .then(data => {
                        this.log('info', 'Geocoding API test successful', data);
                    })
                    .catch(error => {
                        this.log('error', 'Geocoding API test failed:', error);
                    });
            },
            
            testLocation() {
                this.log('info', 'Testing geolocation...');
                
                if (!navigator.geolocation) {
                    this.log('error', 'Geolocation not supported by this browser.');
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude, accuracy } = position.coords;
                        this.log('info', `Geolocation successful: Lat: ${latitude}, Lng: ${longitude}, Accuracy: ${accuracy}m`);
                    },
                    (error) => {
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "User denied geolocation permission.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Location information unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Request to get user location timed out.";
                                break;
                            default:
                                errorMessage = "Unknown error occurred.";
                                break;
                        }
                        this.log('error', `Geolocation failed: ${errorMessage}`);
                    }
                );
            },
            
            getNetworkInfo() {
                this.log('info', 'Getting network information...');
                
                const connection = navigator.connection || 
                                  navigator.mozConnection || 
                                  navigator.webkitConnection;
                
                if (connection) {
                    this.log('info', `Network type: ${connection.effectiveType || 'unknown'}`);
                    this.log('info', `Downlink: ${connection.downlink || 'unknown'} Mbps`);
                    this.log('info', `RTT: ${connection.rtt || 'unknown'} ms`);
                } else {
                    this.log('warn', 'Network information API not available');
                }
                
                // Check if online
                this.log('info', `Online status: ${navigator.onLine ? 'online' : 'offline'}`);
                
                // Ping Google's DNS to check connectivity
                const startTime = Date.now();
                fetch('https://8.8.8.8', { mode: 'no-cors', cache: 'no-store' })
                    .then(() => {
                        const pingTime = Date.now() - startTime;
                        this.log('info', `Ping test successful: ${pingTime}ms`);
                    })
                    .catch(error => {
                        this.log('error', 'Ping test failed:', error);
                    });
            }
        };
        
        // Initialize debug console after page loads
        window.addEventListener('DOMContentLoaded', () => {
            DEBUG.init();
        });

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and tab panes
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding tab pane
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
                
                // Log tab change in debug console
                console.info(`Tab changed to: ${tab.dataset.tab}`);
            });
        });

        // Global variables
        let map;
        let currentMarker;
        let currentPosition = { lat: 20.5937, lng: 78.9629 }; // Default to India
        
        // OpenWeather API key - You need to replace this with a valid API key
        // Visit https://openweathermap.org/appid to sign up for a free API key
        const apiKey = '7ce0d5536639a60b6b020e7320b4df80'; // Your API key
        
        // Check if API key is set
        function isApiKeyConfigured() {
            return apiKey && apiKey !== '' && apiKey !== 'YOUR_OPENWEATHER_API_KEY';
        }
        
        // Initialize the map
        function initMap() {
            console.info('Initializing Google Maps...');
            try {
                map = new google.maps.Map(document.getElementById('weatherMap'), {
                    center: currentPosition,
                    zoom: 5
                });

                // Add click event to map
                map.addListener('click', function(e) {
                    const location = e.latLng;
                    console.info(`Map clicked: Lat: ${location.lat()}, Lng: ${location.lng()}`);
                    updateWeatherForLocation(location.lat(), location.lng());
                    updateMarker(location);
                });

                // Get user's location
                getLocation();
                console.info('Google Maps initialized successfully');
            } catch (error) {
                console.error('Error initializing Google Maps:', error);
                // Try to get weather data even if maps fail
                getLocation();
            }
        }

        // Get user's location
        function getLocation() {
            console.info('Getting user location...');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.info(`Geolocation success - Lat: ${position.coords.latitude}, Lng: ${position.coords.longitude}`);
                        currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Update map center and add marker
                        if (map) {
                            map.setCenter(currentPosition);
                            map.setZoom(10);
                            updateMarker(currentPosition);
                        }
                        
                        // Fetch all weather data for user's location
                        updateWeatherForLocation(currentPosition.lat, currentPosition.lng);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        // Use default location (India)
                        updateWeatherForLocation(currentPosition.lat, currentPosition.lng);
                    },
                    { timeout: 10000 } // Add timeout of 10 seconds
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
                // Use default location (India)
                updateWeatherForLocation(currentPosition.lat, currentPosition.lng);
            }
        }

        // Update marker on map
        function updateMarker(location) {
            if (!map) return;
            
            console.info(`Updating map marker at Lat: ${location.lat}, Lng: ${location.lng}`);
            // Remove existing marker
            if (currentMarker) {
                currentMarker.setMap(null);
            }
            
            // Add new marker
            currentMarker = new google.maps.Marker({
                position: location,
                map: map,
                animation: google.maps.Animation.DROP
            });
        }

        // Update all weather data for a specific location
        function updateWeatherForLocation(lat, lng) {
            console.info(`Updating weather data for Lat: ${lat}, Lng: ${lng}`);
            
            // Show API key error if not configured
            if (!isApiKeyConfigured()) {
                showApiKeyError();
                return;
            }
            
            // Update current location display
            fetchLocationName(lat, lng);
            
            // Fetch current weather
            fetchCurrentWeather(lat, lng);
            
            // Fetch forecast
            fetchForecast(lat, lng);
            
            // Fetch soil data
            fetchSoilData(lat, lng);
            
            // Update last updated time
            const lastUpdated = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdated').textContent = `Last updated: ${lastUpdated}`;
        }

        // Show API key error message
        function showApiKeyError() {
            const errorMessage = `
                <div style="text-align: center; padding: 20px; background-color: #fff3cd; border-left: 5px solid #ffeeba; margin-bottom: 20px;">
                    <h3 style="color: #856404; margin-bottom: 10px;">OpenWeather API Key Required</h3>
                    <p style="margin-bottom: 15px;">To display weather data, you need to add your OpenWeather API key.</p>
                    <ol style="text-align: left; max-width: 600px; margin: 0 auto;">
                        <li>Sign up for a free API key at <a href="https://home.openweathermap.org/users/sign_up" target="_blank">OpenWeatherMap</a></li>
                        <li>After signing up, go to your <a href="https://home.openweathermap.org/api_keys" target="_blank">API keys tab</a></li>
                        <li>Copy your API key</li>
                        <li>Open the weather.html file in your project</li>
                        <li>Find the line: <code>const apiKey = '';</code></li>
                        <li>Replace it with: <code>const apiKey = 'your-api-key-here';</code></li>
                        <li>Save the file and refresh this page</li>
                    </ol>
                    <p style="margin-top: 15px; font-size: 0.9em; color: #856404;">Note: It may take up to 2 hours for a new API key to become active.</p>
                </div>
            `;
            
            // Update all sections with the error message
            document.getElementById('currentWeatherLoading').innerHTML = errorMessage;
            document.getElementById('forecastLoading').innerHTML = errorMessage;
            document.getElementById('soilLoading').innerHTML = errorMessage;
            
            // Make sure the content sections are hidden
            document.getElementById('currentWeatherContent').style.display = 'none';
            document.getElementById('forecastContent').style.display = 'none';
            document.getElementById('soilContent').style.display = 'none';
        }

        // Fetch location name from coordinates
        async function fetchLocationName(lat, lng) {
            if (!isApiKeyConfigured()) return;
            
            try {
                console.info(`Fetching location name for Lat: ${lat}, Lng: ${lng}`);
                const response = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lng}&limit=1&appid=${apiKey}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Location data:", data);
                
                if (data && data.length > 0) {
                    const location = data[0];
                    let locationName = location.name;
                    
                    if (location.state) {
                        locationName += `, ${location.state}`;
                    }
                    
                    if (location.country) {
                        locationName += `, ${location.country}`;
                    }
                    
                    document.getElementById('currentLocation').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${locationName}`;
                } else {
                    document.getElementById('currentLocation').innerHTML = `<i class="fas fa-map-marker-alt"></i> Location: ${lat.toFixed(2)}, ${lng.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error fetching location name:', error);
                document.getElementById('currentLocation').innerHTML = `<i class="fas fa-map-marker-alt"></i> Location: ${lat.toFixed(2)}, ${lng.toFixed(2)}`;
            }
        }

        // Fetch current weather
        async function fetchCurrentWeather(lat, lng) {
            if (!isApiKeyConfigured()) return;
            
            try {
                console.info(`Fetching current weather for Lat: ${lat}, Lng: ${lng}`);
                document.getElementById('currentWeatherLoading').style.display = 'block';
                document.getElementById('currentWeatherContent').style.display = 'none';
                
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${apiKey}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Current weather data:", data);
                
                if (data) {
                    // Update current weather display
                    document.getElementById('temperature').textContent = `${Math.round(data.main.temp)}°C`;
                    document.getElementById('maxTemp').textContent = `${Math.round(data.main.temp_max)}°C`;
                    document.getElementById('minTemp').textContent = `${Math.round(data.main.temp_min)}°C`;
                    document.getElementById('humidity').textContent = `${data.main.humidity}%`;
                    document.getElementById('windSpeed').textContent = `${Math.round(data.wind.speed * 3.6)} km/h`; // Convert from m/s to km/h
                    document.getElementById('visibility').textContent = `${(data.visibility / 1000).toFixed(1)} km`; // Convert from m to km
                    document.getElementById('weatherDescription').textContent = data.weather[0].description;
                    
                    // Set rain chance (if available, otherwise estimate from clouds)
                    const rainChance = data.rain ? Math.min(100, Math.round((data.rain['1h'] || 0) * 20)) : Math.round(data.clouds.all / 2);
                    document.getElementById('rainChance').textContent = `${rainChance}%`;
                    
                    // Update weather icon
                    const weatherIcon = document.getElementById('weatherIcon');
                    const weatherCode = data.weather[0].id;
                    
                    if (weatherCode >= 200 && weatherCode < 300) {
                        weatherIcon.className = 'fas fa-bolt';
                    } else if (weatherCode >= 300 && weatherCode < 500) {
                        weatherIcon.className = 'fas fa-cloud-rain';
                    } else if (weatherCode >= 500 && weatherCode < 600) {
                        weatherIcon.className = 'fas fa-cloud-rain';
                    } else if (weatherCode >= 600 && weatherCode < 700) {
                        weatherIcon.className = 'fas fa-snowflake';
                    } else if (weatherCode >= 700 && weatherCode < 800) {
                        weatherIcon.className = 'fas fa-smog';
                    } else if (weatherCode === 800) {
                        weatherIcon.className = 'fas fa-sun';
                    } else {
                        weatherIcon.className = 'fas fa-cloud';
                    }
                    
                    // Hide loading and show content
                    document.getElementById('currentWeatherLoading').style.display = 'none';
                    document.getElementById('currentWeatherContent').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching current weather:', error);
                document.getElementById('currentWeatherLoading').innerHTML = 
                    `<p>Error loading weather data. Please try again. (${error.message})</p>`;
            }
        }

        // Fetch 7-day forecast
        async function fetchForecast(lat, lng) {
            if (!isApiKeyConfigured()) return;
            
            try {
                console.info(`Fetching forecast for Lat: ${lat}, Lng: ${lng}`);
                document.getElementById('forecastLoading').style.display = 'block';
                document.getElementById('forecastContent').style.display = 'none';
                
                // Using the current weather API to get daily forecasts since the One Call API might require a paid subscription
                const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lng}&units=metric&appid=${apiKey}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Forecast data:", data);
                
                if (data && data.list && data.list.length > 0) {
                    const forecastContainer = document.getElementById('forecastContainer');
                    forecastContainer.innerHTML = '';
                    
                    // Group forecast by day
                    const dailyForecasts = {};
                    
                    data.list.forEach(item => {
                        const date = new Date(item.dt * 1000);
                        const day = date.toLocaleDateString();
                        
                        if (!dailyForecasts[day]) {
                            dailyForecasts[day] = {
                                date: date,
                                temps: [],
                                icons: [],
                                descriptions: [],
                                humidity: [],
                                windSpeed: []
                            };
                        }
                        
                        dailyForecasts[day].temps.push(item.main.temp);
                        dailyForecasts[day].icons.push(item.weather[0].id);
                        dailyForecasts[day].descriptions.push(item.weather[0].description);
                        dailyForecasts[day].humidity.push(item.main.humidity);
                        dailyForecasts[day].windSpeed.push(item.wind.speed);
                    });
                    
                    // Convert to array and take first 7 days
                    const sevenDayForecast = Object.values(dailyForecasts).slice(0, 7);
                    
                    sevenDayForecast.forEach((forecast, index) => {
                        const date = forecast.date;
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                        const dayMonth = date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                        
                        // Calculate average/max/min values
                        const maxTemp = Math.max(...forecast.temps);
                        const minTemp = Math.min(...forecast.temps);
                        const avgHumidity = Math.round(forecast.humidity.reduce((a, b) => a + b, 0) / forecast.humidity.length);
                        const avgWindSpeed = Math.round((forecast.windSpeed.reduce((a, b) => a + b, 0) / forecast.windSpeed.length) * 3.6); // Convert to km/h
                        
                        // Most frequent weather condition
                        const weatherCounts = {};
                        forecast.icons.forEach((id, i) => {
                            const desc = forecast.descriptions[i];
                            weatherCounts[id] = weatherCounts[id] || { count: 0, description: desc };
                            weatherCounts[id].count++;
                        });
                        
                        const mostFrequentWeather = Object.entries(weatherCounts)
                            .sort((a, b) => b[1].count - a[1].count)[0];
                        
                        const weatherCode = parseInt(mostFrequentWeather[0]);
                        const weatherDesc = mostFrequentWeather[1].description;
                        
                        // Determine icon
                        let iconClass = 'fa-cloud';
                        if (weatherCode >= 200 && weatherCode < 300) {
                            iconClass = 'fa-bolt';
                        } else if (weatherCode >= 300 && weatherCode < 500) {
                            iconClass = 'fa-cloud-rain';
                        } else if (weatherCode >= 500 && weatherCode < 600) {
                            iconClass = 'fa-cloud-rain';
                        } else if (weatherCode >= 600 && weatherCode < 700) {
                            iconClass = 'fa-snowflake';
                        } else if (weatherCode >= 700 && weatherCode < 800) {
                            iconClass = 'fa-smog';
                        } else if (weatherCode === 800) {
                            iconClass = 'fa-sun';
                        } else {
                            iconClass = 'fa-cloud';
                        }
                        
                        const forecastItem = document.createElement('div');
                        forecastItem.className = 'forecast-item';
                        forecastItem.innerHTML = `
                            <h4>${index === 0 ? 'Today' : dayName}<br>${dayMonth}</h4>
                            <i class="fas ${iconClass}"></i>
                            <div class="temp">
                                <div>${Math.round(maxTemp)}°C / ${Math.round(minTemp)}°C</div>
                                <div style="font-size: 0.9rem; margin-top: 0.5rem;">${weatherDesc}</div>
                            </div>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <div><i class="fas fa-tint" style="color: #2c5f2d;"></i> ${avgHumidity}%</div>
                                <div><i class="fas fa-wind" style="color: #2c5f2d;"></i> ${avgWindSpeed} km/h</div>
                            </div>
                        `;
                        forecastContainer.appendChild(forecastItem);
                    });
                    
                    document.getElementById('forecastLoading').style.display = 'none';
                    document.getElementById('forecastContent').style.display = 'block';
                } else {
                    throw new Error('No forecast data available');
                }
            } catch (error) {
                console.error('Error fetching forecast:', error);
                document.getElementById('forecastLoading').innerHTML = 
                    `<p>Error loading forecast data. Please try again. (${error.message})</p>`;
            }
        }
        
        // Fetch soil data (using simulated data with more variation by location)
        async function fetchSoilData(lat, lng) {
            if (!isApiKeyConfigured()) return;
            
            try {
                console.info(`Fetching soil data for Lat: ${lat}, Lng: ${lng}`);
                document.getElementById('soilLoading').style.display = 'block';
                document.getElementById('soilContent').style.display = 'none';
                
                // First, get actual weather data to influence our soil data calculation
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${apiKey}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const weatherData = await response.json();
                console.log("Weather data for soil calculations:", weatherData);
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Use weather data to create more realistic soil data
                // Temperature influences soil temperature
                const airTemp = weatherData.main.temp;
                // Humidity and rain influence soil moisture
                const airHumidity = weatherData.main.humidity;
                // Cloud cover influences soil temperature differential
                const cloudiness = weatherData.clouds.all;
                // Recent rain impacts soil moisture
                const hasRecentRain = weatherData.rain && weatherData.rain['1h'] > 0;
                
                // Create a hash value from the location to ensure consistent but varied results
                const locationHash = Math.sin(lat * 100) * Math.cos(lng * 100);
                
                // Soil moisture (higher with more humidity, rain, and lower temperatures)
                const moistureBase = 30 + (airHumidity * 0.4);
                const rainBonus = hasRecentRain ? 15 : 0;
                const tempEffect = Math.max(0, 20 - Math.max(0, airTemp - 15)); // Lower moisture in hot weather
                const moistureVariation = (locationHash * 10) % 15;
                const soilMoisture = Math.min(95, Math.max(10, Math.round(moistureBase + rainBonus + tempEffect + moistureVariation)));
                
                // Soil temperature (correlates with air temperature but with lag and less extreme)
                const tempBase = airTemp * 0.8; // Soil temp is usually lower than air temp
                const cloudEffect = (100 - cloudiness) * 0.05; // More sun = higher soil temp
                const tempVariation = (locationHash * 5) % 8;
                const soilTemperature = Math.round(tempBase + cloudEffect + tempVariation);
                
                // Soil pH (varies by region and soil type)
                // Use location to create regional variation
                const latEffect = (Math.sin(lat) * 1.5);
                const lngEffect = (Math.cos(lng) * 1.5);
                const soilPH = (6.5 + latEffect + lngEffect).toFixed(1);
                
                // Fertility index (based on pH, moisture, and regional factors)
                const phOptimality = 100 - Math.abs(parseFloat(soilPH) - 6.5) * 20; // Optimal pH around 6.5
                const moistureOptimality = 100 - Math.abs(soilMoisture - 60) * 1.2; // Optimal moisture around 60%
                const regionalFactor = (Math.abs(locationHash) * 100) % 30;
                const fertilityIndex = Math.min(98, Math.max(20, Math.round((phOptimality + moistureOptimality) / 2 + regionalFactor)));
                
                document.getElementById('soilMoisture').textContent = `${soilMoisture}%`;
                document.getElementById('soilTemperature').textContent = `${soilTemperature}°C`;
                document.getElementById('soilPH').textContent = soilPH;
                document.getElementById('fertilityIndex').textContent = `${fertilityIndex}/100`;
                
                document.getElementById('soilLoading').style.display = 'none';
                document.getElementById('soilContent').style.display = 'block';
            } catch (error) {
                console.error('Error generating soil data:', error);
                document.getElementById('soilLoading').innerHTML = 
                    `<p>Error loading soil data. Please try again. (${error.message})</p>`;
            }
        }

        // Load weather data on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize debug console
            if (typeof DEBUG !== 'undefined') {
                DEBUG.init();
            }
            
            // If map is not initialized by the time this runs, try to get weather anyway
            setTimeout(() => {
                if (!map) {
                    console.warn('Map not initialized after 3 seconds, getting weather data anyway');
                    getLocation();
                }
            }, 3000);
        });
    </script>
</body>
</html> 
